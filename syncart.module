<?php

/**
 * @file
 * Syncart: syncart.module.
 */

use Drupal\views\ViewExecutable;
use Drupal\commerce_cart\CartSession;
use Drupal\syncart\Controller\CartProvider;
use Drupal\Core\Url;

/**
 * Implements hook_views_pre_view().
 */
function syncart_views_pre_view(ViewExecutable $view, $display_id, array &$args) {

  $account = \Drupal::currentUser();
  $session = \Drupal::request()->getSession();
  $cartSession = new CartSession($session);

  $cart_provider = new CartProvider($cartSession);
  $cart = $cart_provider->getCart($account);

  if ($cart) {
    $cid = $cart->id();
  }

  if ($view->id() == 'commerce_cart_form' && ($display_id == 'block_1' || $display_id == 'block_2')) {
    if (!empty($cid)) {
      $args[0] = $cid;
    }

  }
}

/**
 * Implements hook_page_attachments().
 */
function syncart_page_attachments(array &$page) {
  $page['#attached']['library'][] = 'syncart/syncart';
}

/**
 * Implements hook_view().
 */
function syncart_node_view(array &$build, $entity, $display, $view_mode) {
  $node_type = $entity->getType();
  if ($node_type == 'tovar') {
    $nid = $entity->id();
    $attr = ['attributes' => ['class' => ['use-ajax']]];
    $variations = $entity->field_tovar_variation->getValue();
    foreach ($variations as $key => $variation) {
      $pid = $variation['target_id'];
      $extra = [
        'nid' => $nid,
        'pid' => $pid,
      ];
      $url = Url::fromRoute('cartadd', $extra);

      $build['syncart']['cart-' . $pid] = [
        'link' => ['#markup' => \Drupal::l('В корзину', $url, $attr)],
        'form' => \Drupal::formBuilder()->getForm('Drupal\syncart\Form\AddToCart', $extra),
      ];
    }
  }
}

/**
 * Ajax().
 */
function _syncart_ajax() {
  return TRUE;
}

/**
 * Implements hook_theme().
 */
function syncart_theme() {
  return [
    'answer-card-add' => [
      'template' => 'answer-card-add',
      'variables' => ['data' => [], 'info' => []],
    ],

    'total-cart' => [
      'template' => 'total-cart',
      'variables' => ['data' => [], 'info' => []],
    ],
  ];
}
